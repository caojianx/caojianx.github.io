<!doctype html>
<html lang="en-us">
  <head>
    <title>详解 nginx 配置 // My New Hugo Site</title>
    <meta charset="utf-8" />
    <meta name="generator" content="Hugo 0.69.0" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="author" content="John Doe" />
    <meta name="description" content="" />
    <link rel="stylesheet" href="https://caojianx/caojianx.github.io/css/main.min.61bb32028587f24ca28522d8d197970c7ef33284e5fffb45a75fcbbb2dbc4dcb.css" />

    
    <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="详解 nginx 配置"/>
<meta name="twitter:description" content="详解 nginx 配置 常用配置项 我们日常工作中经常会对 nginx 进行配置
... ... #核心摸块  events { #事件模块  ... } http { # http 模块  server { # server块  location [PATTERN] { # location块  ... } location [PATTERN] { ... } } server { ... } } mail { # mail 模块  server { # server块  ... } } 核心模块 user admin; #配置用户或者组。  worker_processes 4; #允许生成的进程数，默认为1  pid /nginx/pid/nginx."/>

    <meta property="og:title" content="详解 nginx 配置" />
<meta property="og:description" content="详解 nginx 配置 常用配置项 我们日常工作中经常会对 nginx 进行配置
... ... #核心摸块  events { #事件模块  ... } http { # http 模块  server { # server块  location [PATTERN] { # location块  ... } location [PATTERN] { ... } } server { ... } } mail { # mail 模块  server { # server块  ... } } 核心模块 user admin; #配置用户或者组。  worker_processes 4; #允许生成的进程数，默认为1  pid /nginx/pid/nginx." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://caojianx/caojianx.github.io/post/blog/" />
<meta property="article:published_time" content="2020-04-22T13:08:28+08:00" />
<meta property="article:modified_time" content="2020-04-22T13:08:28+08:00" />


  </head>
  <body>
    <header class="app-header">
      <a href="https://caojianx/caojianx.github.io/"><img class="app-header-avatar" src="/caojianx.github.io/avatar.jpg" alt="John Doe" /></a>
      <h1>My New Hugo Site</h1>
      <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Nunc vehicula turpis sit amet elit pretium.</p>
      <div class="app-header-social">
        
      </div>
    </header>
    <main class="app-container">
      
  <article class="post">
    <header class="post-header">
      <h1 class ="post-title">详解 nginx 配置</h1>
      <div class="post-meta">
        <div>
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-calendar">
  <title>calendar</title>
  <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line>
</svg>
          Apr 22, 2020
        </div>
        <div>
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-clock">
  <title>clock</title>
  <circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline>
</svg>
          3 min read
        </div></div>
    </header>
    <div class="post-content">
      <h1 id="详解-nginx-配置">详解 nginx 配置</h1>
<h2 id="常用配置项">常用配置项</h2>
<p>我们日常工作中经常会对 nginx 进行配置</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-nginx" data-lang="nginx"><span style="color:#66d9ef">...</span>              
<span style="color:#e6db74">...</span>            <span style="color:#75715e">#核心摸块
</span><span style="color:#75715e"></span>
<span style="color:#e6db74">events</span> {        <span style="color:#75715e">#事件模块
</span><span style="color:#75715e"></span>
   <span style="color:#f92672">...</span>
<span style="color:#960050;background-color:#1e0010">}</span>

<span style="color:#e6db74">http</span> {     <span style="color:#75715e"># http 模块
</span><span style="color:#75715e"></span>
    <span style="color:#f92672">server</span> {      <span style="color:#75715e"># server块
</span><span style="color:#75715e"></span>
        <span style="color:#f92672">location</span> <span style="color:#e6db74">[PATTERN]</span> {  <span style="color:#75715e"># location块
</span><span style="color:#75715e"></span>
            <span style="color:#f92672">...</span>
        <span style="color:#960050;background-color:#1e0010">}</span>
        <span style="color:#e6db74">location</span> <span style="color:#e6db74">[PATTERN]</span> {

            <span style="color:#f92672">...</span>
        <span style="color:#960050;background-color:#1e0010">}</span>
    <span style="color:#960050;background-color:#1e0010">}</span>
    <span style="color:#e6db74">server</span> {
      <span style="color:#f92672">...</span>
    <span style="color:#960050;background-color:#1e0010">}</span>

<span style="color:#960050;background-color:#1e0010">}</span>

<span style="color:#e6db74">mail</span> {     <span style="color:#75715e"># mail 模块
</span><span style="color:#75715e"></span>
     <span style="color:#f92672">server</span> {    <span style="color:#75715e"># server块
</span><span style="color:#75715e"></span>          <span style="color:#f92672">...</span>
    <span style="color:#960050;background-color:#1e0010">}</span>

<span style="color:#960050;background-color:#1e0010">}</span>
</code></pre></div><h3 id="核心模块">核心模块</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-nginx" data-lang="nginx"><span style="color:#66d9ef">user</span> <span style="color:#e6db74">admin</span>; <span style="color:#75715e">#配置用户或者组。
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">worker_processes</span> <span style="color:#ae81ff">4</span>; <span style="color:#75715e">#允许生成的进程数，默认为1 
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">pid</span> <span style="color:#e6db74">/nginx/pid/nginx.pid</span>; <span style="color:#75715e">#指定 nginx 进程运行文件存放地址 
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">error_log</span> <span style="color:#e6db74">log/error.log</span> <span style="color:#e6db74">debug</span>; <span style="color:#75715e">#错误日志路径，级别。
</span></code></pre></div><h3 id="事件模块">事件模块</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-nginx" data-lang="nginx"><span style="color:#66d9ef">events</span> { 
    <span style="color:#f92672">accept_mutex</span> <span style="color:#66d9ef">on</span>; <span style="color:#75715e">#设置网路连接序列化，防止惊群现象发生，默认为on 
</span><span style="color:#75715e"></span>
    <span style="color:#f92672">multi_accept</span> <span style="color:#66d9ef">on</span>; <span style="color:#75715e">#设置一个进程是否同时接受多个网络连接，默认为off 
</span><span style="color:#75715e"></span>
    <span style="color:#f92672">use</span> <span style="color:#e6db74">epoll</span>; <span style="color:#75715e">#事件驱动模型select|poll|kqueue|epoll|resig
</span><span style="color:#75715e"></span>
    <span style="color:#f92672">worker_connections</span> <span style="color:#ae81ff">1024</span>; <span style="color:#75715e">#最大连接数
</span><span style="color:#75715e"></span>    }
</code></pre></div><h3 id="http-模块">http 模块</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-nginx" data-lang="nginx"><span style="color:#66d9ef">http</span> {
    <span style="color:#f92672">include</span>       <span style="color:#e6db74">mime.types</span>;   <span style="color:#75715e">#文件扩展名与文件类型映射表
</span><span style="color:#75715e"></span>
    <span style="color:#f92672">default_type</span>  <span style="color:#e6db74">application/octet-stream</span>; <span style="color:#75715e">#默认文件类型，默认为text/plain
</span><span style="color:#75715e"></span>
    <span style="color:#f92672">access_log</span> <span style="color:#66d9ef">off</span>; <span style="color:#75715e">#取消服务日志    
</span><span style="color:#75715e"></span>
    <span style="color:#f92672">sendfile</span> <span style="color:#66d9ef">on</span>;   <span style="color:#75715e">#允许 sendfile 方式传输文件，默认为off，可以在http块，server块，location块。
</span><span style="color:#75715e"></span>
    <span style="color:#f92672">sendfile_max_chunk</span> <span style="color:#ae81ff">100k</span>;  <span style="color:#75715e">#每个进程每次调用传输数量不能大于设定的值，默认为0，即不设上限。
</span><span style="color:#75715e"></span>
    <span style="color:#f92672">keepalive_timeout</span> <span style="color:#ae81ff">65</span>;  <span style="color:#75715e">#连接超时时间，默认为75s，可以在http，server，location块。
</span><span style="color:#75715e"></span>    <span style="color:#f92672">server</span> 
    {
            <span style="color:#f92672">keepalive_requests</span> <span style="color:#ae81ff">120</span>; <span style="color:#75715e">#单连接请求上限次数。
</span><span style="color:#75715e"></span>
            <span style="color:#f92672">listen</span> <span style="color:#ae81ff">80</span>; <span style="color:#75715e">#监听端口
</span><span style="color:#75715e"></span>
            <span style="color:#f92672">server_name</span>  <span style="color:#ae81ff">127</span><span style="color:#e6db74">.0.0.1</span>;   <span style="color:#75715e">#监听地址      
</span><span style="color:#75715e"></span>
            <span style="color:#f92672">index</span> <span style="color:#e6db74">index.html</span> <span style="color:#e6db74">index.htm</span> <span style="color:#e6db74">index.php</span>;

            <span style="color:#f92672">root</span> <span style="color:#e6db74">your_path</span>;  <span style="color:#75715e">#根目录
</span><span style="color:#75715e"></span>
            <span style="color:#f92672">location</span> ~ <span style="color:#e6db74">\.php$</span>
            {
                  <span style="color:#f92672">fastcgi_pass</span> <span style="color:#e6db74">unix:/var/run/php/php7.1-fpm.sock</span>;

                  <span style="color:#75715e">#fastcgi_pass 127.0.0.1:9000;
</span><span style="color:#75715e"></span>
                  <span style="color:#f92672">fastcgi_index</span> <span style="color:#e6db74">index.php</span>;

                  <span style="color:#f92672">include</span> <span style="color:#e6db74">fastcgi_params</span>;
            }

    }
}
</code></pre></div><h3 id="配置详解项">配置详解项</h3>
<ul>
<li>worker_processes
worker_processes 用来设置 Nginx 服务的进程数。该值推荐使用 CPU 内核数。</li>
<li>worker_cpu_affinity
worker_cpu_affinity 用来为每个进程分配CPU的工作内核，参数有多个二进制值表示，每一组代表一个进程，每组中的每一位代表该进程使用CPU的情况，1代表使用，0代表不使用。所以我们使用 worker_cpu_affinity 0001 0010 0100 1000;来让进程分别绑定不同的核上。默认情况下worker进程不绑定在任何一个CPU上。</li>
<li>worker_rlimit_nofile
设置毎个进程的最大文件打开数。如果不设的话上限就是系统的 ulimit –n的数字，一般为65535。</li>
<li>worker_connections
设置一个进程理论允许的最大连接数，理论上越大越好，但不可以超过 worker_rlimit_nofile 的值。</li>
<li>use epoll
设置事件驱动模型使用 epoll。epoll 是 Nginx 支持的高性能事件驱动库之一。是公认的非 常优秀的事件驱动模型。</li>
<li>accept_mutex off
关闭网络连接序列化，当其设置为开启的时候，将会对多个 Nginx 进程接受连接进行序列化，防止多个进程对连接的争抢。当服务器连接数不多时，开启这个参数会让负载有一定程度的降低。但是当服务器的吞吐量很大时，为了效率，请关闭这个参数；并且关闭这个参数的时候也可以让请求在多个 worker 间的分配更均衡。所以我们设置 accept_mutex off;</li>
<li>multi_accept on
设置一个进程可同时接受多个网络连接</li>
<li>Sendfile on
Sendfile是 Linux2.0 以后的推出的一个系统调用,它能简化网络传输过程中的步骤，提高服务器性能。
不用 sendfile的传统网络传输过程：
硬盘 &raquo; kernel buffer &raquo; user buffer &raquo; kernel socket buffer &raquo; 协议栈
用 sendfile()来进行网络传输的过程：
硬盘 &raquo; kernel buffer (快速拷贝到 kernelsocket buffer) &raquo;协议栈</li>
<li>tcp_nopush on;
设置数据包会累积一下再一起传输，可以提高一些传输效率。 tcp_nopush 必须和 sendfile 搭配使用。</li>
<li>tcp_nodelay on;
小的数据包不等待直接传输。默认为on。 看上去是和 tcp_nopush 相反的功能，但是两边都为 on 时 nginx 也可以平衡这两个功能的使用。</li>
<li>keepalive_timeout
HTTP 连接的持续时间。设的太长会使无用的线程变的太多。这个根据服务器访问数量、处理速度以及网络状况方面考虑。</li>
<li>send_timeout
设置 Nginx 服务器响应客户端的超时时间，这个超时时间只针对两个客户端和服务器建立连接后，某次活动之间的时间，如果这个时间后，客户端没有任何活动，Nginx服务器将关闭连接</li>
<li>gzip on
启用 gzip，对响应数据进行在线实时压缩,减少数据传输量。</li>
<li>gzip_disable &ldquo;msie6&rdquo;
Nginx服务器在响应这些种类的客户端请求时，不使用 Gzip 功能缓存应用数据，gzip_disable “msie6”对IE6浏览器的数据不进行 GZIP 压缩。</li>
</ul>
<h3 id="location">Location</h3>
<p>location 查找规则</p>
<pre><code class="language-nignx" data-lang="nignx">   location  = / {
 # 精确匹配 / ，主机名后面不能带任何字符串
 [ config A ]
}

   location  / {
 # 因为所有的地址都以 / 开头，所以这条规则将匹配到所有请求
 # 但是正则和最长字符串会优先匹配
 [ config B ]
}

   location /documents/ {
 # 匹配任何以 /documents/ 开头的地址，匹配符合以后，还要继续往下搜索
 # 只有后面的正则表达式没有匹配到时，这一条才会采用这一条
 [ config C ]
}

   location ~ /documents/Abc {
 # 匹配任何以 /documents/Abc 开头的地址，匹配符合以后，还要继续往下搜索
 # 只有后面的正则表达式没有匹配到时，这一条才会采用这一条
 [ config CC ]
}

   location ^~ /images/ {
 # 匹配任何以 /images/ 开头的地址，匹配符合以后，停止往下搜索正则，采用这一条。
 [ config D ]
}

   location ~* \.(gif|jpg|jpeg)$ {
 # 匹配所有以 gif,jpg或jpeg 结尾的请求
 # 然而，所有请求 /images/ 下的图片会被 config D 处理，因为 ^~ 到达不了这一条正则
 [ config E ]
}

   location /images/ {
 # 字符匹配到 /images/，继续往下，会发现 ^~ 存在
 [ config F ]
}

   location /images/abc {
 # 最长字符匹配到 /images/abc，继续往下，会发现 ^~ 存在
 # F与G的放置顺序是没有关系的
 [ config G ]
}

   location ~ /images/abc/ {
   # 只有去掉 config D 才有效：先最长匹配 config G 开头的地址，继续往下搜索，匹配到这一条正则，采用
   [ config H ]
}
</code></pre><ul>
<li>
<p>正则查找优先级从高到低依次如下：</p>
</li>
<li>
<p>“ = ” 开头表示精确匹配，如 A 中只匹配根目录结尾的请求，后面不能带任何字符串。</p>
</li>
<li>
<p>“ ^~ ” 开头表示uri以某个常规字符串开头，不是正则匹配</p>
</li>
<li>
<p>“ ~ ” 开头表示区分大小写的正则匹配;</p>
</li>
<li>
<p>“ ~* ”开头表示不区分大小写的正则匹配</p>
</li>
<li>
<p>“ / ” 通用匹配, 如果没有其它匹配,任何请求都会匹配到</p>
</li>
</ul>
<h3 id="负载均衡配置">负载均衡配置</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-nginx" data-lang="nginx">   <span style="color:#66d9ef">upstream</span> <span style="color:#e6db74">test-upstream</span> {
       <span style="color:#f92672">ip_hash</span>; <span style="color:#75715e"># 使用 ip_hash 算法分配
</span><span style="color:#75715e"></span>
       <span style="color:#f92672">server</span> <span style="color:#ae81ff">192</span><span style="color:#e6db74">.168.1.1</span>; <span style="color:#75715e"># 要分配的 ip
</span><span style="color:#75715e"></span>       <span style="color:#f92672">server</span> <span style="color:#ae81ff">192</span><span style="color:#e6db74">.168.1.2</span>;
   }

   <span style="color:#66d9ef">server</span> {

       <span style="color:#f92672">location</span> <span style="color:#e6db74">/</span> {       
           <span style="color:#f92672">proxy_pass</span> <span style="color:#e6db74">http://test-upstream</span>;
       }

   }
</code></pre></div><ul>
<li>上面的例子定义了一个 test-upstream 的负载均衡配置，通过 proxy_pass 反向代理指令将请求转发给该模块进行分配处理。</li>
</ul>

    </div>
    <div class="post-footer">
      
    </div>
  </article>

    </main>
  </body>
</html>
